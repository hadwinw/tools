#!/usr/bin/bash


####以下爲服務器安裝caddy+v2ray和關閉系統日誌的安裝腳本，如果需要
####使用caddy，請先進行域名配置，不然不起作用

#################################################################
####判斷系統


#################################################################
####關閉系統日誌系統，不再記錄所有記錄
systemlog_disable(){
    jour_file="/etc/systemd/journald.conf"
    echo '[Journal]' > $jour_file
    echo "Storage=none" >> $jour_file
    echo "ForwardToSyslog=no" >> $jour_file
    systemctl restart systemd-journald

    systemctl stop rsyslog
    systemctl disable rsyslog
    apt purge -y rsyslog
    rm -rf /var/log/*
}



ssh_remote_key(){
    cat > /etc/ssh/sshd_config <<EOF
PermitRootLogin yes
MaxAuthTries 3
MaxSessions 3
PasswordAuthentication no
ChallengeResponseAuthentication no
UsePAM yes
AllowAgentForwarding no
AllowTcpForwarding no
X11Forwarding no
PrintMotd no
PrintLastLog no
ClientAliveInterval 20
ClientAliveCountMax 3
UseDNS no
PermitTunnel no
Banner none
AcceptEnv LANG LC_*
Subsystem	sftp	/usr/lib/openssh/sftp-server

EOF
    

    mkdir -p $USER/.ssh
    cat > $USER/.ssh/authorized_keys <<EOF
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDJ9ua/c7C/xCZz41e7mtSm9QfIgaEFm5yQS+tBFpk5cl38SY06w/ZPjHYPoR+4IWAsYItc8t8r0zr8Lifdq9706/mspM+UxA3kYDtHz2CUEjiDGwolY3cLeTRMDnLPr2OYHPpNJEsTd2Vxtn2imT1p4VnMkwOaNHoXVe2iKv63vlngsCxsDXOMWdnnGi/8weiWoKUkHUxssEINg5GeD+FY1FY8yy+QO/OB7AAY/FtW6jvRE0sutzhlIn9rph6lidH6KW+mNwt5luE8y+MtAgu7oHR7BkeC0jsJbj+D5LMwoLz9UUdM/LCJhQJpenUwsBm0h+hEDmQr+CVKOjyOlp0F+txkX9ItgRjjYpXGp9gHV98gUSVJBLJE0WkSofxUnYiIns7uxyy+cituaVi9L2Im/y94rQqqqcZ+mdgtWFmTwpcX6tUKMolPx8o4XiwY04W2uZWR4Ehdrr9qVdwQi2kce9GckJOxB9to4JA+pJGvZI2bf1sMpQ2pU/UOR4klAKc= hadwin@debian

EOF
    chmod 600 $USER/.ssh/authorized_keys

    systemctl restart ssh
}


system_update() {
    apt update -y
    apt upgrade -y
    [ $? == 0 ] && echo "1" > $PWD/update
    sync
    sleep 5
    systemctl reboot
}

deps_install(){
    apt install -y curl debian-keyring debian-archive-keyring apt-transport-https qrencode
}



#################################################################
####安裝caddy，這是debian系列的安裝方式，其他方式以後補全
####caddy默認關閉admin管理
caddy_install(){
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | tee /etc/apt/trusted.gpg.d/caddy-stable.asc
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
    apt update
    apt install caddy
}

caddy_file() {
    domain="$1"
    
    cat > /etc/caddy/Caddyfile <<EOF
{
	admin off
	log {
	    output discard
	    level ERROR
	}
}
https://$domain {
	root * /usr/share/caddy
	file_server

	handle_errors {
	        rewrite * /var/www/html/500.html
		rewrite /*.gif /var/www/html/unicorn.gif
		file_server 
   	}

	@v2ray_ws {
		path /ws
		header Connection Upgrade
		header Upgrade websocket
	}
	reverse_proxy @v2ray_ws localhost:10808
	
	reverse_proxy /h2c localhost:10809 {
		transport http {
			versions h2c
		}
	}

	reverse_proxy /trojan localhost:10810 {
		 transport http {
			tls
			tls_server_name overroad.cf
			tls_insecure_skip_verify
		}
	}
}
EOF

    systemctl restart caddy
}


#################################################################
####安裝v2ray
####選擇特定版本還是最新版本
v2ray_install(){
    bash <(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)
    bash <(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-dat-release.sh)
}

v2ray_config(){
    domain="$1"
    uuid="$2"
    
    cat > /usr/local/etc/v2ray/config.json <<EOF
{
    "log": {
	"loglevel": "none"
    },
    "inbounds": [
       {
            "port": 10808,
            "listen":"127.0.0.1",
            "protocol": "vmess",
            "settings": {
		"clients": [
		    {
			"id": "$uuid",
			"alterId": 0
		    }
		]
            },
            "streamSettings": {
		"network": "ws",
		"wsSettings": {
		    "path": "/ws"
		}
            }
	},
	{
	    "port": "10809",
	    "listen": "127.0.0.1",
	    "domainOverride": ["http", "tls"],
	    "protocol": "vmess",
	    "settings": {
		"clients": [
		    {
			"id": "$uuid",
			"alterId": 0
		    }
		]
	    },
	    "streamSettings": {
		"network": "h2",
		"httpSettings": {
		    "path": "/h2c",
		    "host": [
			"$domain"
		    ]
		}
	    }
	}
    ],
    "outbounds": [
	{
	    "protocol": "freedom",
	    "settings": {}
	}
    ]
}

EOF

    systemctl restart v2ray
}




#############################################################
v2ray_qrcode(){
    qrencode -r $1 -o $1.png
}


v2ray_vmess() {
    $domain="$1"
    $uuid="$2"
    cat > /tmp/ws.cs <<EOF
{
"v": "2",
"ps": "v2ray_ws",
"add": "$domain",
"port": "443",
"id": "$uuid",
"aid": "0",
"scy": "",
"net": "ws",
"type": "none",
"host": "",
"path": "/ws",
"tls": "tls",
}

EOF
    cat > /tmp/h2c.cs <<EOF 
{
"v": "2",
"ps": "v2ray_h2c",
"add": "$domain",
"port": "443",
"id": "$uuid",
"aid": "0",
"scy": "",
"net": "h2",
"type": "none",
"host": "$domain",
"path": "/h2",
"tls": "tls",
"sni": "$domain"
}

EOF
    
    echo -n "vmess://" > v2ray_ws.txt
    base64 -w 0 /tmp/ws.cs >> v2ray_ws.txt
    echo "v2ray_ws的vmess連接爲："
    cat v2ray_ws.txt
    echo "v2ray_ws的二維碼爲："
    v2ray_qrcode v2ray_ws.txt
    
    echo -n "vmess://" >> v2ray_h2c.txt
    base64 -w 0 /tmp/h2c.cs >> v2ray_h2c.txt
    echo "v2ray_h2c的vmess連接爲："
    cat v2ray_h2c.txt
    echo "v2ray_h2c的二維碼爲："
    v2ray_qrcode v2ray_h2c.txt

    cat v2ray_ws.txt > $3
    echo >> sub.txt
    echo >> sub.txt
    cat v2ray_h2c.txt >> $3

    
    echo "訂閱地址爲："
    echo "https://$domain/$(basename $3)"
}





#############################################################
####clash訂閱地址
clash_sub(){
   echo ""    
}



function change_root_password(){
    root_password=`openssl rand -hex 20 | openssl passwd -1 --stdin`
    echo "root:$root_password" | chpasswd -e
}



##################################主程序####################################
domain="minicast.ml"
uuid=`uuidgen -r`

##1.更新系统到最新，并创建一个文件暂时记录系统更新状态，重启系统后会自动再执行脚本进行后续的安装
system_update

##2.更改密码密码
change_root_password

##3.更改ssh的配置，不允许远程密码登录，创建authkey文件，只允许基于ssh-key的登录
ssh_remote_key

##4.关闭系统日志，并删除系统日志
systemlog_disable


##5.安装依赖包 curl 等
deps_install

##6.安装v2ray
v2ray_install
v2ray_config $domain $uuid

##7.安装caddy
caddy_install
caddy_file $domain

sub_html="/usr/share/caddy/sub.html"
##8.创建v2ray订阅连接
v2ray_vmess $domain $uuid $sub_html


##9.创建clash订阅连接

##10.输出安装后的信息


##11. 
